name: üöÄ Remote Server Deployment

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  validate-deps-only:
    runs-on: ubuntu-latest

    outputs:
      not_allowed: ${{ steps.check.outputs.not_allowed }}

    if: github.event_name == 'push'

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: üîç Find last successful workflow run
        id: lastrun
        run: |
          last_sha=$(gh run list \
            --workflow "${GITHUB_WORKFLOW}" \
            --branch "${GITHUB_REF#refs/heads/}" \
            --status success \
            --limit 1 \
            --json headSha \
            | jq -r '.[0].headSha // empty')

          echo "Last successful run SHA: $last_sha"
          echo "sha=$last_sha" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üïµÔ∏è Check if automatic deployment allowed
        id: check
        run: |
          if [ -z "${{ steps.lastrun.outputs.sha }}" ]; then
            RANGE=""
          else
            RANGE="${{ steps.lastrun.outputs.sha }}..HEAD"
          fi

          NOT_ALLOWED_COMMITS=$(git log --no-merges $RANGE \
              --invert-grep \
              --grep='^chore\((deps|template)\):' \
              --extended-regexp \
              --format='%s')

          if [ -n "$NOT_ALLOWED_COMMITS" ]; then
            echo "not_allowed=true" >> $GITHUB_OUTPUT
          else
            echo "not_allowed=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    runs-on: ubuntu-latest
    environment: production
    needs: [validate-deps-only]

    if: |
      always() &&
      (
        github.event_name == 'workflow_dispatch' ||
        needs.validate-deps-only.outputs.not_allowed == 'false'
      )

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: üîê Create Wireguard overlay
        run: |
          sudo apt install resolvconf wireguard
          echo "${{ secrets.WIREGUARD_CONFIG }}" > wg0.conf
          sudo chmod 600 wg0.conf
          sudo wg-quick up ./wg0.conf
      
      - name: ‚öôÔ∏è Pre-deploy
        if: hashFiles('.github/workflows/pre-deploy/action.yml') != ''
        uses: ./.github/workflows/pre-deploy
        with:
          ssh_host: ${{ secrets.DEPLOY_SSH_HOST }}
          ssh_user: ${{ vars.DEPLOY_SSH_USERNAME }}
          ssh_key: ${{ secrets.DEPLOY_SSH_KEY }}
          ssh_port: ${{ secrets.DEPLOY_SSH_PORT }}

      - name: üöÄ Deploy to Remote Server
        uses: appleboy/ssh-action@823bd89e131d8d508129f9443cad5855e9ba96f0 # v1.2.4
        with:
          host: ${{ secrets.DEPLOY_SSH_HOST }}
          username: ${{ vars.DEPLOY_SSH_USERNAME }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_SSH_PORT }}
          script: ability compose-stack-update ${{ github.ref_name }}

      - name: üßπ Post-deploy
        if: hashFiles('.github/workflows/post-deploy/action.yml') != ''
        uses: ./.github/workflows/post-deploy
        with:
          ssh_host: ${{ secrets.DEPLOY_SSH_HOST }}
          ssh_user: ${{ vars.DEPLOY_SSH_USERNAME }}
          ssh_key: ${{ secrets.DEPLOY_SSH_KEY }}
          ssh_port: ${{ secrets.DEPLOY_SSH_PORT }}
