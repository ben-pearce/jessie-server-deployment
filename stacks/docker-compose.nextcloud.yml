name: nextcloud
include:
  - common/docker-compose.secrets.yml
  - common/docker-compose.volumes.yml
services:
  nextcloud:
    image: nextcloud:31.0.9@sha256:c05096c9f9c9141438be9270b4ee2ec80c927673e83a088c3a76d27b783d5aed
    container_name: nextcloud
    depends_on:
      - nextcloud-postgres
    volumes:
      - ${DATA_DIR}/nextcloud/html:/var/www/html
      - ${DATA_DIR}/nextcloud/apps:/var/www/html/custom_apps
      - ${DATA_DIR}/nextcloud/data:/var/www/html/data
      - cloud:/var/www/html/data/ben/files
      - ${CONFIG_DIR}/nextcloud:/var/www/html/config
    secrets:
      - nextcloud_postgres_password
      - smtp_password
    environment:
      - POSTGRES_DB=nextcloud
      - POSTGRES_USER=nextcloud
      - POSTGRES_PASSWORD_FILE=/run/secrets/nextcloud_postgres_password
      - POSTGRES_HOST=nextcloud-postgres
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_SECURE=ssl
      - SMTP_PORT=465
      - SMTP_NAME=${SMTP_USER}
      - SMTP_PASSWORD_FILE=/run/secrets/smtp_password
      - MAIL_FROM=${SMTP_USER}
      - REDIS_HOST=nextcloud-redis
      - REDIS_PORT=6379
    networks:
      - nextcloud
      - nextcloud-web
    restart: unless-stopped
    labels:
      ofelia.enabled: 'true'
      ofelia.job-exec.nextcloud-cron.command: php /var/www/html/cron.php
      ofelia.job-exec.nextcloud-cron.schedule: 0 */5 * * * *
      ofelia.job-exec.nextcloud-cron.user: www-data
      readme.description: Personal Cloud Storage
      readme.links.docker: https://hub.docker.com/_/nextcloud
      readme.links.web: https://nextcloud.com/
      traefik.docker.network: nextcloud-web
      traefik.enable: true
      traefik.http.middlewares.nextcloud-hsts.headers.customresponseheaders.Strict-Transport-Security: max-age=15552000;
      traefik.http.routers.nextcloud.entrypoints: https
      traefik.http.routers.nextcloud.middlewares: nextcloud-hsts
      traefik.http.routers.nextcloud.rule: Host(`nextcloud.${HOST}`)
      glance.id: nextcloud
      glance.name: Nextcloud
      glance.icon: di:nextcloud
      glance.url: https://nextcloud.${HOST}
      glance.description: Personal Cloud
      glance.category: cloud
  nextcloud-postgres:
    image: postgres:17.6@sha256:e6a4209d1a4893f2df3bdcde58f8926c3c929c4d51df90990ed1b36d83c1382a
    container_name: nextcloud-postgres
    volumes:
      - nextcloud-postgres:/var/lib/postgresql/data
      - ${DATA_DIR}/postgres/nextcloud:/docker-entrypoint-initdb.d
    secrets:
      - nextcloud_postgres_password
    environment:
      POSTGRES_DB: nextcloud
      POSTGRES_PASSWORD_FILE: /run/secrets/nextcloud_postgres_password
      POSTGRES_USER: nextcloud
    networks:
      - nextcloud
    restart: unless-stopped
    labels:
      glance.parent: nextcloud
      glance.name: DB
      glance.category: cloud
  nextcloud-redis:
    image: redis:8.2.2@sha256:f0957bcaa75fd58a9a1847c1f07caf370579196259d69ac07f2e27b5b389b021
    container_name: nextcloud-redis
    networks:
      - nextcloud
    restart: unless-stopped
    labels:
      glance.parent: nextcloud
      glance.name: KV
      glance.category: cloud
networks:
  nextcloud:
    name: nextcloud
  nextcloud-web:
    name: nextcloud-web
volumes:
  nextcloud-postgres:
    name: nextcloud-postgres
secrets:
  nextcloud_postgres_password:
    file: ../.secrets/nextcloud_postgres_password
